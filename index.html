<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExamHub | Premium Admin</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-dark: #0f172a;
            --text-light: #64748b;
            --radius: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background-color: var(--bg-body); color: var(--text-dark); min-height: 100vh; display: flex; flex-direction: column; }
        
        /* --- UTILITY --- */
        .hidden { display: none !important; }
        .flex-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- AUTH SCREEN --- */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; background: white; z-index: 2000; }
        .auth-brand { flex: 1; background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; }
        .auth-form-container { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; background: white; }
        .auth-card { width: 100%; max-width: 400px; }
        .auth-input { width: 100%; padding: 14px 14px 14px 45px; border: 2px solid #e2e8f0; border-radius: var(--radius); font-family: inherit; transition: 0.3s; background: #f8fafc; }
        .auth-input:focus { border-color: var(--primary); background: white; outline: none; }
        .input-group { position: relative; margin-bottom: 20px; }
        .input-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .auth-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: 0.3s; }
        
        /* --- NAV --- */
        nav { background: white; padding: 0.8rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; flex-wrap: wrap; gap: 15px; box-shadow: var(--shadow-sm); z-index: 100; }
        .nav-left { display: flex; align-items: center; gap: 30px; }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); display:flex; align-items:center; gap:10px; cursor: pointer; letter-spacing: -0.5px; }
        .nav-admin { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 8px 16px; border-radius: 30px; font-size: 0.8rem; font-weight: 600; cursor: pointer; text-decoration: none; box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2); transition: 0.2s; }
        .nav-admin:hover { transform: translateY(-1px); box-shadow: 0 6px 8px rgba(239, 68, 68, 0.3); }
        .nav-item { color: var(--text-light); font-weight: 500; cursor: pointer; transition: 0.2s; }
        .nav-item:hover { color: var(--primary); }
        .cat-select { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-weight: 600; outline: none; cursor: pointer; background: #f8fafc; }

        .app-container { max-width: 1200px; margin: 0 auto; width: 100%; padding: 30px 20px; flex-grow: 1; overflow-y: auto; }

        /* --- DASHBOARD --- */
        .dash-grid { display: grid; grid-template-columns: 2.5fr 1fr; gap: 30px; }
        .card { background: white; border-radius: 16px; padding: 25px; border: 1px solid #f1f5f9; box-shadow: var(--shadow-sm); }
        .test-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #f1f5f9; border-radius: 10px; margin-bottom: 10px; transition:0.2s; }
        .test-item:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: var(--shadow-md); }
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; margin-left: 8px; }
        .tag-net { background: #e0e7ff; color: var(--primary); }

        /* --- TEST INTERFACE --- */
        .test-layout { display: flex; gap: 25px; height: calc(100vh - 130px); }
        .q-area { flex: 3; background: white; border-radius: 16px; padding: 30px; border: 1px solid #f1f5f9; overflow-y: auto; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; justify-content: space-between; }
        .p-area { flex: 1; background: white; border-radius: 16px; padding: 20px; border: 1px solid #f1f5f9; display: flex; flex-direction: column; box-shadow: var(--shadow-sm); }
        .q-text { font-size: 1.15rem; line-height: 1.6; margin-bottom: 25px; color: #334155; }
        .opt-list li { padding: 15px; border: 2px solid #f1f5f9; border-radius: 10px; margin-bottom: 12px; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .opt-list li:hover { border-color: #cbd5e1; background: #f8fafc; }
        .opt-list li.selected { border-color: var(--primary); background: #eef2ff; color: var(--primary); font-weight: 600; }
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; overflow-y: auto; padding: 2px; }
        .qn { height: 35px; width: 35px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.85rem; font-weight: 600; background: #f1f5f9; color: #64748b; }
        .qn.answered { background: var(--success); color: white; }
        .qn.review { background: #8b5cf6; color: white; }
        .qn.visited { background: var(--danger); color: white; }
        .qn.current { border: 2px solid #0f172a; transform: scale(1.1); }

        /* --- PREMIUM ADMIN PANEL --- */
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .admin-title h3 { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); margin: 0; }
        .admin-title p { color: var(--text-light); margin: 0; font-size: 0.9rem; }

        /* Admin Stats */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 20px; border: 1px solid #f1f5f9; position: relative; overflow: hidden; }
        .stat-card::after { content: ''; position: absolute; right: -20px; top: -20px; width: 80px; height: 80px; background: var(--bg-body); border-radius: 50%; opacity: 0.5; }
        .stat-icon { width: 55px; height: 55px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-info h4 { margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--text-dark); }
        .stat-info p { margin: 0; color: var(--text-light); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Admin Grid */
        .admin-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; }
        .admin-card { background: white; border-radius: 16px; box-shadow: var(--shadow-sm); overflow: hidden; height: fit-content; border: 1px solid #e2e8f0; }
        
        .card-header { padding: 20px 25px; border-bottom: 1px solid #f1f5f9; background: #fafafa; display: flex; justify-content: space-between; align-items: center; }
        .card-header h4 { margin: 0; font-weight: 700; color: var(--text-dark); display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
        .card-body { padding: 25px; }

        /* Team Input Design */
        .invite-box { display: flex; gap: 0; background: white; border: 2px solid #e2e8f0; border-radius: 10px; padding: 5px; transition: 0.2s; }
        .invite-box:focus-within { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        .invite-input { border: none; outline: none; flex-grow: 1; padding: 8px 15px; font-size: 0.95rem; font-family: inherit; }
        .invite-btn { background: var(--text-dark); color: white; border: none; padding: 8px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .invite-btn:hover { background: black; }

        /* Team List */
        .team-member { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .team-member:last-child { border-bottom: none; }
        .avatar { width: 36px; height: 36px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; margin-right: 12px; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3); }
        
        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; font-size: 0.9rem; }
        .btn-pri { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2); }
        .btn-pri:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-sec { background: white; border: 1px solid #e2e8f0; color: var(--text-dark); }
        .btn-sec:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-dan { background: #fee2e2; color: #ef4444; padding: 6px 12px; font-size: 0.8rem; border-radius: 6px; }
        .btn-dan:hover { background: #fecaca; }
        
        /* Create Form Elements */
        .form-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; margin-bottom: 15px; font-family: inherit; font-size: 0.95rem; background: #f8fafc; transition: 0.2s; }
        input:focus, textarea:focus, select:focus { background: white; border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        /* Options Grid */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .option-wrapper { display: flex; align-items: center; background: white; border: 1px solid #cbd5e1; border-radius: 10px; padding: 8px; transition: 0.2s; }
        .option-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        .opt-badge { width: 30px; height: 30px; background: #f1f5f9; color: var(--text-light); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; margin-right: 10px; }
        .opt-field { border: none; outline: none; flex-grow: 1; padding: 5px; font-size: 0.95rem; background: transparent; font-family: inherit; margin: 0; }

        @media (max-width: 900px) {
            .dash-grid, .admin-grid { grid-template-columns: 1fr; }
            .test-layout { flex-direction: column; height: auto; }
            .question-area { min-height: 400px; padding: 20px; }
            .palette-area { order: 2; margin-top: 20px; }
        }
        @media (max-width: 768px) {
            .auth-brand { display: none; }
            .nav-left { width: 100%; justify-content: space-between; }
            .nav-right { display: none; } /* Hide on mobile for space */
            .logo { font-size: 1.2rem; }
            .form-grid, .options-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-brand">
            <div style="font-size:4rem; margin-bottom:20px; color:rgba(255,255,255,0.9);"><i class="fas fa-layer-group"></i></div>
            <h1 style="margin:0;">ExamHub</h1>
            <p style="opacity:0.8;">Enterprise Testing Solution</p>
        </div>
        <div class="auth-form-container">
            <div class="auth-card">
                <div style="margin-bottom:30px;">
                    <h2 style="margin:0;">Welcome</h2>
                    <p style="color:#64748b; margin:5px 0;">Sign in to your account</p>
                </div>
                <div class="input-group">
                    <i class="fas fa-envelope input-icon"></i>
                    <input type="email" id="auth-email" class="auth-input" placeholder="Email Address">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" id="auth-pass" class="auth-input" placeholder="Password">
                </div>
                <button class="auth-btn" id="auth-btn" onclick="handleAuth()">Sign In</button>
                <div style="margin-top:25px; text-align:center; font-size:0.9rem;">
                    <span class="link" style="color:var(--primary); cursor:pointer;" onclick="toggleAuth()">Create Account</span><br><br>
                    <span class="link" style="color:#94a3b8; cursor:pointer;" onclick="resetPassword()">Forgot Password?</span>
                </div>
            </div>
        </div>
    </div>

    <nav id="navbar" class="hidden">
        <div class="nav-left">
            <div class="logo"><i class="fas fa-cube"></i> ExamHub</div>
            <div id="nav-links" class="hidden" style="display:flex; gap:15px; align-items:center;">
                <a class="nav-item" onclick="showSection('student-dashboard')">Dashboard</a>
                <a id="admin-link" class="nav-admin hidden" onclick="showSection('admin-panel')">Admin Console</a>
            </div>
        </div>
        <div id="user-controls" class="hidden" style="display:flex; align-items:center; gap:15px;">
            <select id="main-category-select" class="cat-select" onchange="filterCategory()">
                <option value="ALL">All Exams</option>
                <option value="NET">UGC NET</option>
                <option value="GATE">GATE</option>
                <option value="SET">SET</option>
                <option value="OTHER">Other</option>
            </select>
            <div style="text-align:right; line-height:1.2;">
                <div style="font-size:0.75rem; color:#94a3b8; font-weight:600;">ROLE</div>
                <div id="user-role-badge" style="font-weight:700; font-size:0.85rem; color:var(--primary);">Student</div>
            </div>
            <button class="btn btn-sec" style="padding:8px 12px;" onclick="handleLogout()"><i class="fas fa-power-off"></i></button>
        </div>
    </nav>

    <div class="app-container hidden" id="main-container">
        <div id="loading-indicator" class="hidden" style="text-align:center;"><div class="loader" style="display:inline-block;"></div></div>

        <div id="student-dashboard" class="hidden">
            <div class="dash-grid">
                <div class="card">
                    <h3 style="margin-top:0; border-bottom:1px solid #f1f5f9; padding-bottom:15px; color:var(--text-dark);">Available Tests</h3>
                    <div id="test-list-container">Loading...</div>
                </div>
                <div class="card" style="height:fit-content;">
                    <h3 style="margin-top:0;">ðŸ“œ Recent Activity</h3>
                    <div id="history-container"><p style="color:#94a3b8; font-size:0.9rem;">No tests taken yet.</p></div>
                </div>
            </div>
        </div>

        <div id="test-interface" class="hidden">
            <div class="flex-row" style="margin-bottom:15px;">
                <h3 id="test-title-display" style="margin:0;">Test Title</h3>
                <div id="timer-display" style="background:var(--danger); color:white; padding:8px 16px; border-radius:10px; font-weight:700; font-family:monospace; font-size:1.1rem; box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2);">00:00</div>
            </div>
            <div class="test-layout">
                <div class="q-area">
                    <div>
                        <div style="color:#64748b; font-weight:600; margin-bottom:10px; text-transform:uppercase; font-size:0.85rem; letter-spacing:1px;">Question <span id="q-num-disp">1</span></div>
                        <div id="question-container" class="q-text"></div>
                    </div>
                    <div style="border-top:1px solid #f1f5f9; padding-top:20px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
                        <div style="display:flex; gap:10px;">
                            <button class="btn" style="background:#8b5cf6; color:white;" onclick="markForReview()">Review</button>
                            <button class="btn btn-sec" onclick="clearResponse()">Clear</button>
                        </div>
                        <button class="btn btn-pri" onclick="nextQuestion()">Save & Next</button>
                    </div>
                </div>
                <div class="p-area">
                    <h4 style="margin-top:0;">Question Status</h4>
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:15px; background:#f8fafc; padding:10px; border-radius:10px;">
                        <span style="color:var(--success)"><b>Done:</b> <span id="count-attempt">0</span></span>
                        <span style="color:var(--danger)"><b>Left:</b> <span id="count-left">0</span></span>
                    </div>
                    <div class="palette-grid" id="palette-grid-container"></div>
                    <button class="btn btn-success" style="margin-top:auto; width:100%; padding:15px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);" onclick="submitTest()">SUBMIT TEST</button>
                </div>
            </div>
        </div>

        <div id="result-screen" class="hidden" style="text-align:center; padding:40px;">
            <div class="card" style="max-width:600px; margin:0 auto; text-align:center;">
                <i class="fas fa-medal" style="font-size:5rem; color:var(--warning); margin-bottom:20px; text-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);"></i>
                <h2>Test Completed!</h2>
                <div style="font-size:3.5rem; font-weight:800; color:var(--primary); margin:10px 0;" id="score-display"></div>
                <p id="percentage-display" style="color:#64748b; font-size:1.2rem;"></p>
                <div style="text-align:left; margin-top:30px;" id="analysis-container"></div>
                <br>
                <button class="btn btn-pri" onclick="showSection('student-dashboard')">Return to Dashboard</button>
            </div>
        </div>

        <div id="admin-panel" class="hidden">
            <div class="admin-header">
                <div class="admin-title">
                    <h3>Admin Console</h3>
                    <p>Welcome back, Master.</p>
                </div>
                <button class="btn btn-sec" onclick="showSection('student-dashboard')">Exit to App</button>
            </div>

            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-icon" style="background:linear-gradient(135deg, #6366f1, #4338ca);"><i class="fas fa-file-alt"></i></div>
                    <div class="stat-info"><h4 id="stat-tests">0</h4><p>Total Tests</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-users"></i></div>
                    <div class="stat-info"><h4 id="stat-teachers">0</h4><p>Teachers</p></div>
                </div>
            </div>

            <div class="admin-grid">
                <div id="master-zone" class="hidden admin-card">
                    <div class="card-header">
                        <h4><i class="fas fa-crown" style="color:var(--warning);"></i> Team Management</h4>
                        <span style="font-size:0.75rem; color:#94a3b8; font-weight:600; text-transform:uppercase;">Admin Only</span>
                    </div>
                    <div class="card-body">
                        <label style="font-size:0.85rem; font-weight:600; margin-bottom:5px; display:block;">Add New Teacher</label>
                        <div class="invite-box">
                            <input id="new-teacher-email" class="invite-input" placeholder="Enter user email address...">
                            <button class="invite-btn" onclick="promoteUser()">Promote</button>
                        </div>
                        
                        <div style="margin-top:25px;">
                            <div style="font-size:0.75rem; color:#94a3b8; font-weight:700; margin-bottom:10px; letter-spacing:0.5px;">ACTIVE TEACHERS</div>
                            <div id="team-list">Loading...</div>
                        </div>
                    </div>
                </div>

                <div class="admin-card" style="grid-column: span 2;">
                    <div class="card-header">
                        <h4><i class="fas fa-layer-group"></i> Test Library</h4>
                        <button class="btn btn-pri btn-sm" onclick="openCreateMode()"><i class="fas fa-plus"></i> Create Test</button>
                    </div>
                    <div class="card-body">
                        
                        <div id="create-test-form" class="hidden" style="background:#f8fafc; padding:30px; border-radius:16px; border:1px solid #e2e8f0; margin-bottom:30px; box-shadow:inset 0 2px 4px rgba(0,0,0,0.02);">
                            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                                <h4 id="form-title" style="margin:0; font-size:1.2rem;">Create New Test</h4>
                                <button class="btn btn-sec btn-sm" onclick="closeForm()">Cancel</button>
                            </div>
                            
                            <div class="form-grid">
                                <input id="test-title" placeholder="Test Title (e.g. June 2024 Paper)">
                                <input type="number" id="test-duration" placeholder="Duration (Minutes)" value="60">
                                <select id="test-category"><option value="NET">UGC NET</option><option value="GATE">GATE</option><option value="SET">SET</option><option value="OTHER">Other</option></select>
                            </div>
                            
                            <div style="background:white; padding:25px; border-radius:12px; border:1px solid #e2e8f0; box-shadow:var(--shadow-sm);">
                                <label style="font-weight:600; font-size:0.9rem; display:block; margin-bottom:10px;">Question Content</label>
                                <textarea id="q-text" placeholder="Type question text here (Supports HTML & MathJax)..." style="height:100px;"></textarea>
                                <input type="file" id="q-image" style="margin-bottom:20px;">
                                
                                <label style="font-weight:600; font-size:0.9rem; display:block; margin-bottom:10px;">Options</label>
                                <div class="options-grid">
                                    <div class="option-wrapper"><div class="opt-badge">A</div><input id="opt-1" class="opt-field" placeholder="Option A"></div>
                                    <div class="option-wrapper"><div class="opt-badge">B</div><input id="opt-2" class="opt-field" placeholder="Option B"></div>
                                    <div class="option-wrapper"><div class="opt-badge">C</div><input id="opt-3" class="opt-field" placeholder="Option C"></div>
                                    <div class="option-wrapper"><div class="opt-badge">D</div><input id="opt-4" class="opt-field" placeholder="Option D"></div>
                                </div>

                                <div class="flex-row" style="margin-top:20px;">
                                    <select id="correct-opt" style="margin:0; width:auto; flex-grow:1;"><option value="0">Correct Answer: A</option><option value="1">Correct Answer: B</option><option value="2">Correct Answer: C</option><option value="3">Correct Answer: D</option></select>
                                    <button class="btn btn-sec" onclick="addQToStage()"><i class="fas fa-plus"></i> Add to Queue</button>
                                </div>
                            </div>
                            
                            <div style="margin:20px 0; display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight:600; color:var(--text-light);">Queue: <span id="q-count" style="color:var(--primary); font-weight:800;">0</span> Questions</span>
                                <button id="save-btn" class="btn btn-pri" onclick="saveTest()">Save Test to Cloud</button>
                            </div>
                            
                            <div id="staging-list" style="max-height:150px; overflow-y:auto; background:white; border-radius:10px; border:1px solid #e2e8f0; padding:10px;"></div>
                        </div>

                        <div id="admin-test-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCkmD-GkkU8DkuzuhLDXmena2HOVfb-tbY",
            authDomain: "mock-test-88fbc.firebaseapp.com",
            projectId: "mock-test-88fbc",
            storageBucket: "mock-test-88fbc.firebasestorage.app",
            messagingSenderId: "45637040362",
            appId: "1:45637040362:web:393d258292d58f99f53f93",
            measurementId: "G-ZQ0P06H40C"
        };
        const MASTER_EMAIL = "gurup2076@gmail.com";

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null, currentRole = 'student', allTests = [], filteredTests = [];
        let currentTest = null, currentQuestionIndex = 0, userAnswers = [], questionStatus = [], stagingQs = [], editingTestId = null, timerInterval = null, isRegistering = false;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('navbar').classList.remove('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                document.getElementById('nav-links').classList.remove('hidden');
                document.getElementById('user-controls').classList.remove('hidden');
                await resolveRole(user);
                showSection('student-dashboard');
            } else {
                currentUser = null;
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('navbar').classList.add('hidden');
                document.getElementById('main-container').classList.add('hidden');
            }
        });

        async function resolveRole(user) {
            currentRole = 'student';
            if(user.email.toLowerCase() === MASTER_EMAIL.toLowerCase()) currentRole = 'master';
            else {
                try {
                    const d = await db.collection('users').doc(user.uid).get();
                    if(d.exists && d.data().role === 'teacher') currentRole = 'teacher';
                } catch(e){}
            }
            const rName = currentRole==='master'?'Admin':(currentRole==='teacher'?'Teacher':'Student');
            document.getElementById('user-role-badge').innerText = rName;
            if(currentRole !== 'student') document.getElementById('admin-link').classList.remove('hidden');
        }

        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const btn = document.getElementById('auth-btn');
            if(!email || !pass) return alert("Fill fields");
            btn.innerText = "Processing...";
            try {
                if(isRegistering) {
                    const c = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.collection('users').doc(c.user.uid).set({email, role:'student', history:[]});
                    alert("Welcome!");
                } else await auth.signInWithEmailAndPassword(email, pass);
            } catch(e) { alert(e.message); }
            btn.innerText = isRegistering ? "Sign Up" : "Sign In";
        }

        function toggleAuth() {
            isRegistering = !isRegistering;
            document.getElementById('auth-header').innerText = isRegistering ? "Create Account" : "Welcome Back";
            document.getElementById('auth-btn').innerText = isRegistering ? "Sign Up" : "Sign In";
        }
        function resetPassword() { const e = prompt("Email:"); if(e) auth.sendPasswordResetEmail(e).then(()=>alert("Sent")).catch(err=>alert(err.message)); }
        function handleLogout() { auth.signOut(); location.reload(); }

        function showSection(id) {
            clearInterval(timerInterval);
            document.querySelectorAll('.app-container > div').forEach(d => { if(d.id!=='loading-indicator') d.classList.add('hidden'); });
            document.getElementById(id).classList.remove('hidden');
            if(id === 'student-dashboard') loadDashboard();
            if(id === 'admin-panel') loadAdmin();
        }

        function filterCategory() { renderTestList(document.getElementById('main-category-select').value); }

        async function loadDashboard() {
            document.getElementById('loading-indicator').classList.remove('hidden');
            const snap = await db.collection('tests').orderBy('createdAt', 'desc').get();
            allTests = snap.docs.map(d => ({id:d.id, ...d.data()}));
            filterCategory();
            const u = await db.collection('users').doc(currentUser.uid).get();
            const h = u.exists ? (u.data().history || []) : [];
            document.getElementById('history-container').innerHTML = h.reverse().map(i => `
                <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between;">
                    <span style="font-weight:500">${i.title}</span> <span style="color:${i.score/i.total>.5?'var(--success)':'var(--danger)'}; font-weight:700;">${i.score}/${i.total}</span>
                </div>
            `).join('') || "<p style='color:#94a3b8'>No history.</p>";
            document.getElementById('loading-indicator').classList.add('hidden');
        }

        function renderTestList(cat) {
            if(cat === 'ALL') filteredTests = allTests; else filteredTests = allTests.filter(t => t.category === cat);
            document.getElementById('test-list-container').innerHTML = filteredTests.length ? filteredTests.map(t => `
                <div class="test-item">
                    <div>
                        <div style="font-weight:600; font-size:1.05rem;">${t.title} <span class="tag ${t.category==='GATE'?'tag-gate':'tag-net'}">${t.category||'NET'}</span></div>
                        <div style="color:#64748b; font-size:0.85rem; margin-top:5px;">${t.questions.length} Questions | ${t.duration} Minutes</div>
                    </div>
                    <button class="btn btn-pri" onclick="startTest('${t.id}')">Start</button>
                </div>
            `).join('') : '<p style="color:#94a3b8; padding:20px;">No tests found.</p>';
        }

        function startTest(id) {
            currentTest = allTests.find(t => t.id === id);
            userAnswers = new Array(currentTest.questions.length).fill(null);
            questionStatus = new Array(currentTest.questions.length).fill('not-visited');
            questionStatus[0] = 'visited';
            currentQuestionIndex = 0;
            showSection('test-interface');
            document.getElementById('test-title-display').innerText = currentTest.title;
            renderQ(); updateP(); startTimer(currentTest.duration);
        }

        function renderQ() {
            const q = currentTest.questions[currentQuestionIndex];
            if(questionStatus[currentQuestionIndex]==='not-visited') questionStatus[currentQuestionIndex]='visited';
            document.getElementById('q-num-disp').innerText = currentQuestionIndex+1;
            document.getElementById('question-container').innerHTML = `
                <div>${q.question}</div>
                ${q.image ? `<img src="${q.image}" style="max-width:100%; border-radius:8px; margin:15px 0; border:1px solid #e2e8f0;">` : ''}
                <ul class="opt-list">${q.options.map((o, i) => `<li class="${userAnswers[currentQuestionIndex]===i?'selected':''}" onclick="selAns(${i})">${o}</li>`).join('')}</ul>
            `;
            if(window.MathJax) MathJax.typesetPromise();
            updateP();
        }

        function selAns(i) { userAnswers[currentQuestionIndex]=i; questionStatus[currentQuestionIndex]='answered'; renderQ(); }
        function clearResponse() { userAnswers[currentQuestionIndex]=null; questionStatus[currentQuestionIndex]='visited'; renderQ(); }
        function markForReview() { questionStatus[currentQuestionIndex]='review'; updateP(); nextQuestion(); }
        function nextQuestion() { if(currentQuestionIndex < currentTest.questions.length-1) { currentQuestionIndex++; renderQ(); } }
        
        function updateP() {
            let att = 0;
            document.getElementById('palette-grid-container').innerHTML = questionStatus.map((s,i) => {
                if(s==='answered') att++;
                let cls = s==='answered'?'answered':s==='review'?'review':s==='visited'?'visited':'';
                if(i===currentQuestionIndex) cls+=' current';
                return `<div class="qn ${cls}" onclick="currentQuestionIndex=${i};renderQ()">${i+1}</div>`;
            }).join('');
            document.getElementById('count-attempt').innerText = att;
            document.getElementById('count-left').innerText = currentTest.questions.length - att;
        }

        async function submitTest() {
            if(!confirm("Submit?")) return;
            clearInterval(timerInterval);
            let score = 0; userAnswers.forEach((a, i) => { if(a === currentTest.questions[i].answer) score++; });
            await db.collection('users').doc(currentUser.uid).update({ history: firebase.firestore.FieldValue.arrayUnion({title: currentTest.title, score, total: currentTest.questions.length, date: new Date()}) });
            showSection('result-screen');
            document.getElementById('score-display').innerText = `${score} / ${currentTest.questions.length}`;
            document.getElementById('percentage-display').innerText = `${((score/currentTest.questions.length)*100).toFixed(1)}% Score`;
            
            document.getElementById('analysis-container').innerHTML = currentTest.questions.map((q, i) => {
                const correct = userAnswers[i] === q.answer;
                return `<div style="border-bottom:1px solid #e2e8f0; padding-bottom:15px; margin-bottom:15px;">
                    <div style="font-weight:600; color:${correct?'var(--success)':'var(--danger)'}">Q${i+1}: ${correct?'Correct':'Wrong'}</div>
                    <div style="margin:5px 0;">${q.question}</div>
                    <div style="background:#f1f5f9; padding:10px; border-radius:6px; font-size:0.9rem;">
                        <div>Your Answer: <b>${userAnswers[i]!==null ? q.options[userAnswers[i]] : 'Skipped'}</b></div>
                        <div style="color:var(--success)">Correct Answer: <b>${q.options[q.answer]}</b></div>
                    </div>
                </div>`;
            }).join('');
            if(window.MathJax) MathJax.typesetPromise();
        }

        function startTimer(min) {
            let s = min*60;
            timerInterval = setInterval(() => {
                s--; document.getElementById('timer-display').innerText = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
                if(s<=0) submitTest();
            }, 1000);
        }

        /* ADMIN */
        const toBase64 = f => new Promise((r,j)=>{const x=new FileReader();x.readAsDataURL(f);x.onload=()=>r(x.result);x.onerror=j;});
        function loadAdmin() {
            if(currentRole === 'master') {
                document.getElementById('master-zone').classList.remove('hidden');
                loadTeam();
            } else document.getElementById('master-zone').classList.add('hidden');
            loadAdminTests();
        }
        
        async function loadTeam() {
            const snap = await db.collection('users').where('role','==','teacher').get();
            document.getElementById('stat-teachers').innerText = snap.size;
            document.getElementById('team-list').innerHTML = snap.empty ? '<small style="color:#94a3b8">No teachers added.</small>' : snap.docs.map(d => `
                <div class="team-member">
                    <div style="display:flex; align-items:center;">
                        <div class="avatar">${d.data().email.substring(0,2).toUpperCase()}</div>
                        <div style="font-weight:500;">${d.data().email}</div>
                    </div>
                    <button class="btn-dan" onclick="demoteUser('${d.id}')">Remove</button>
                </div>
            `).join('');
        }
        
        async function promoteUser() {
            const e = document.getElementById('new-teacher-email').value;
            const s = await db.collection('users').where('email','==',e).get();
            if(s.empty) return alert("User not found (Must register first)");
            await db.collection('users').doc(s.docs[0].id).update({role:'teacher'});
            document.getElementById('new-teacher-email').value = '';
            loadTeam();
        }
        async function demoteUser(uid) {
            if(confirm("Remove access?")) { await db.collection('users').doc(uid).update({role:'student'}); loadTeam(); }
        }

        async function loadAdminTests() {
            const snap = await db.collection('tests').orderBy('createdAt','desc').get();
            allTests = snap.docs.map(d => ({id:d.id, ...d.data()}));
            document.getElementById('stat-tests').innerText = allTests.length;
            document.getElementById('admin-test-list').innerHTML = allTests.map(t => `
                <div class="test-item">
                    <div>
                        <div style="font-weight:600;">${t.title}</div>
                        <div style="font-size:0.8rem; color:var(--text-light); margin-top:2px;"><span class="tag tag-net" style="margin:0">${t.category||'NET'}</span> â€¢ ${t.questions.length} Questions</div>
                    </div>
                    <div>
                        <button class="btn-sec" onclick="editTest('${t.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-dan" onclick="delTest('${t.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
        }

        function openCreateMode() { editingTestId=null; stagingQs=[]; document.getElementById('test-title').value=''; document.getElementById('form-title').innerText="Create New Test"; document.getElementById('save-btn').innerText="Save Test to Cloud"; updateStage(); document.getElementById('create-test-form').classList.remove('hidden'); }
        
        function editTest(id) {
            const t = allTests.find(x => x.id === id); editingTestId=id; stagingQs=[...t.questions];
            document.getElementById('test-title').value=t.title; document.getElementById('test-duration').value=t.duration; document.getElementById('test-category').value=t.category||'NET';
            document.getElementById('form-title').innerText="Edit Test"; document.getElementById('save-btn').innerText="Update Test"; updateStage();
            document.getElementById('create-test-form').classList.remove('hidden'); document.getElementById('create-test-form').scrollIntoView();
        }

        async function addQToStage() {
            const txt = document.getElementById('q-text').value; const img = document.getElementById('q-image').files[0];
            const opts = [1,2,3,4].map(i => document.getElementById('opt-'+i).value);
            if(!txt && !img) return alert("No content");
            let d = null; if(img) d = await toBase64(img);
            stagingQs.push({question:txt, image:d, options:opts, answer:parseInt(document.getElementById('correct-opt').value)});
            updateStage(); document.getElementById('q-text').value='';
        }
        function updateStage() {
            document.getElementById('q-count').innerText = stagingQs.length;
            document.getElementById('staging-list').innerHTML = stagingQs.map((q,i) => `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #e2e8f0; padding:10px; align-items:center;"><span><span style="font-weight:700; color:var(--primary)">Q${i+1}</span></span><button class="btn-dan" onclick="stagingQs.splice(${i},1);updateStage()"><i class="fas fa-trash"></i></button></div>`).join('');
        }
        
        async function saveTest() {
            const t = document.getElementById('test-title').value; if(!t) return alert("Title req");
            const btn = document.getElementById('save-btn'); btn.innerText="Saving...";
            const d = {title:t, duration:document.getElementById('test-duration').value, category:document.getElementById('test-category').value, questions:stagingQs, author:currentUser.email, updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
            if(!d.createdAt && !editingTestId) d.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            if(editingTestId) await db.collection('tests').doc(editingTestId).update(d); else await db.collection('tests').add(d);
            closeForm(); loadAdminTests(); btn.innerText="Save";
        }
        function closeForm() { document.getElementById('create-test-form').classList.add('hidden'); }
        async function delTest(id) { if(confirm("Delete?")) { await db.collection('tests').doc(id).delete(); loadAdminTests(); }}
    </script>
</body>
</html>